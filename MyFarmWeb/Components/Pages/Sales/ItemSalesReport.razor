@page "/item-sales-report/{CustomersId}/{ItemsId}/{StoresId}/{from:datetime}/{to:datetime}/{InvoiceId:int}"
@using System.Text.Json
@using MyFarmWeb.Components.Pages.DataGridSettingsFolder
@using MyFarmWeb.Repository.special.Class
@using Radzen.Blazor.Rendering
@layout Layout.EmptyLayout
@inject SetDataGridSetting dgsetting
@inject IUnitOfWork unitofwork
@inject IJSRuntime JSRuntime
@inject NavigationManager nav
@rendermode InteractiveServer
@inject Service service
@using Microsoft.JSInterop
@inject DialogService DialogService
@inject IJSRuntime JSRuntime
<title>تقرير مبيعات اصناف</title>
<RadzenCard>
    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" class="rz-m-12" Gap="2rem">
            <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        </RadzenStack>
    }
    <RadzenStack Orientation="Orientation.Horizontal" Style="width:50%;margin-right:40px;">
        <RadzenLabel Component="DropDownfrozen">اختيار الاعمده </RadzenLabel>
        <RadzenDropDownDataGrid Multiple="true" Chips="true" @ref=gridColumns ShowSearch="false" SearchTextPlaceholder="بحث" 
                                @bind-Value=ColumnsFrozen Data=@dataGridColumnsFrozens AllowClear="true"
                                TextProperty="@nameof(DataGridColumnsFrozen.ColumnTitle)" ValueProperty="@nameof(DataGridColumnsFrozen.ColumnKey)" AllowFiltering="true" Name="DropDownfrozen">
            <Columns>
                <RadzenDropDownDataGridColumn Width="60px" Sortable="false">
                    <HeaderTemplate>
                        <RadzenCheckBox InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "اختيار الكل" }})" Disabled="@(!gridColumns.AllowSelectAll)" TriState="false" TValue="bool"
                                        Change="@(args => ColumnsFrozen = args ? gridColumns.View.Cast<DataGridColumnsFrozen>().Select(c => c.ColumnKey) : ColumnsFrozen = Enumerable.Empty<string>())" />
                    </HeaderTemplate>
                    <Template Context="data">
                        <RadzenCheckBox InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "اختار عمود" }})" TriState="false" Value="@(ColumnsFrozen != null && ColumnsFrozen.Contains(((DataGridColumnsFrozen) data).ColumnKey))"
                                        TValue="bool" Change=@(args => gridColumns.SelectItem(data)) @onclick:stopPropagation />
                    </Template>
                </RadzenDropDownDataGridColumn>


                <RadzenDropDownDataGridColumn Property="@nameof(DataGridColumnsFrozen.ColumnTitle)" Title="اسم العمود" />

            </Columns>
        </RadzenDropDownDataGrid>
        <RadzenButton ButtonStyle="ButtonStyle.Danger" Text="تجميد" Click="@FrozenColumn" />
    </RadzenStack>


</RadzenCard>
<RadzenDataGrid class="mb-5" @bind-Settings=_settings @ref=invoicegrid AllowFiltering="true" AllowAlternatingRows="true" AllowColumnResize="true" FilterMode="FilterMode.SimpleWithMenu" AllowSorting="true"
                Data="@Invoices" AllowGrouping="true" AllowPaging="false" PagerHorizontalAlign="Radzen.HorizontalAlign.Left" ShowPagingSummary="true" GroupFootersAlwaysVisible="true" TItem="InvoiceForReport"
                ColumnWidth="50px" Style="height:600px;" GroupPanelText="اسحب هنا للتجميع" AllGroupsExpanded="IsExpand" LogicalFilterOperator="LogicalFilterOperator.And" SelectionMode="DataGridSelectionMode.Single" @bind-Value=@selecteditem
                ApplyFilterText="تصفية" EmptyText="لايوجد بيانات " ShowMultiColumnSortingIndex="true" AllowMultiColumnSorting="true" ColumnReordered="FrozenColumn" ClearFilterText="الغاء" AllowColumnReorder="true" AllowColumnPicking="true" ColumnsShowingText="اظهار الاعمدة" GridLines="DataGridGridLines.Both">

    <HeaderTemplate>
        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="اضافة فاتورة" Click="@add" />
        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="expand" Text="توسيع" Click="@expand" />
        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="switch_left" Text="تجميع" Click="@collapse" />
        <RadzenButton Icon="add" Click="OpenLayouts" Text="المخطط"></RadzenButton>

    </HeaderTemplate>
    <Columns>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.DocumentType)" Title="نوع الفاتورة" Width="160px" OrderIndex="1"></RadzenDataGridColumn>

        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Date)" Title="التاريخ" Width="160px" OrderIndex="2">
            <Template Context="data">
                @data.Date.ToString("yyyy-MM-dd")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.InvoiceId)" Title="رقم الفاتورة" Width="160px" OrderIndex="3">

            <FooterTemplate>
                <b>@invoicegrid.View.Select(i => i.InvoiceId).Distinct().Count()</b>
            </FooterTemplate>
            <GroupFooterTemplate Context="data">
                <b>@data.Data.Count</b>
            </GroupFooterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.ManId)" Title="كود العميل" Width="160px" OrderIndex="4" />
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.ManName)" Title="اسم العميل" Width="160px" OrderIndex="5" />
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Id)" Title="رقم البند" Width="160px" OrderIndex="6">
            <FooterTemplate>
                <b>@invoicegrid.View.Count()</b>
            </FooterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.ItemName)" Title="اسم الصنف" Width="160px" OrderIndex="7" />

        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Store)" Title="المخزن" Width="160px" OrderIndex="8" />
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Unit)" Title="الوحدة" Width="160px" OrderIndex="9" />

        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Quantity)" Title="الكمية" Width="160px" OrderIndex="10">

            <FooterTemplate>
                <b>@invoicegrid.View.Sum(i => i.Quantity).ToString("N3")</b>
            </FooterTemplate>
            <GroupFooterTemplate>
                <b>@(context.Data.Items.Cast<InvoiceForReport>().Sum(i => i.Quantity).ToString("N3"))</b>
            </GroupFooterTemplate>

        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Price)" Title="السعر" Width="160px" OrderIndex="11">
            <Template Context="data">
                @data.Price.ToString("N3")
            </Template>

        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.UnitCost)" Title="التكلفه" Width="160px" OrderIndex="11">
            <Template Context="data">
                @data.UnitCost.ToString("N3")
            </Template>

        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.TotalCost)" Title="قيمة التكلفه" Width="160px" OrderIndex="11">
            <Template Context="data">
                @data.TotalCost.ToString("N3")
            </Template>

        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Amount)" Title="القيمة" Width="160px" OrderIndex="12">
            <Template Context="data">
                @data.Amount.ToString("N3")
            </Template>
            <FooterTemplate>

                <b>@invoicegrid.View.Sum(i => i.Amount).ToString("N3")</b>
            </FooterTemplate>
            <GroupFooterTemplate>
                <b>@(context.Data.Items.Cast<InvoiceForReport>().Sum(i => i.Amount).ToString("N3"))</b>
            </GroupFooterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Discount)" Title="الخصم" Width="160px" OrderIndex="13">
            <Template Context="data">
                @data.Discount.ToString("N3")
            </Template>
            <FooterTemplate>
                <b>@invoicegrid.View.Sum(i => i.Discount).ToString("N3")</b>
            </FooterTemplate>
            <GroupFooterTemplate>
                <b>@(context.Data.Items.Cast<InvoiceForReport>().Sum(i => i.Discount).ToString("N3"))</b>
            </GroupFooterTemplate>

        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.NetAmount)" FormatString="N3" Title="صافى القيمة" Width="160px" OrderIndex="14">
            <Template Context="data">
                @data.NetAmount.ToString("N3")
            </Template>
            <FooterTemplate>
                <b>@invoicegrid.View.Sum(i => i.NetAmount).ToString("N3")</b>
            </FooterTemplate>
            <GroupFooterTemplate>
                <b>@(context.Data.Items.Cast<InvoiceForReport>().Sum(i => i.NetAmount).ToString("N3"))</b>
            </GroupFooterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="@nameof(InvoiceForReport.Note)" Title="الملاحظات" Width="160px" OrderIndex="15" />
        <RadzenDataGridColumn Frozen=true Width="70px" FrozenPosition="FrozenColumnPosition.Right" TextAlign="Radzen.TextAlign.Right" Filterable="false" Sortable="false" Groupable="false">
            <Template Context="data">
                <RadzenButton Click="@(args => Edit(data))" Icon="edit"></RadzenButton>
            </Template>
        </RadzenDataGridColumn>

    </Columns>

</RadzenDataGrid>
@code {
    IEnumerable<string> ColumnsFrozen = new string[] { };
    RadzenDropDownDataGrid<IEnumerable<string>> gridColumns;
    bool isfrozen;
    List<DataGridColumnsFrozen> dataGridColumnsFrozens = new();
    RadzenButton btnpopup;
    Popup popup;
    public string GridId { get; set; } = "item-sales-report";
    // حفظ اعدادات الجريد
    DataGridSettings _settings;
    public DataGridSettings Settings
    {
        get
        {
            return _settings;
        }
        set
        {
            if (_settings != value)
            {
                _settings = value;

            }
        }
    }

    //---------------------
    LoadDataArgs LoadDataArgs = new();
    [Parameter]
    public string CustomersId { get; set; }
    [Parameter]
    public int InvoiceId { get; set; }

    [Parameter]
    public string ItemsId { get; set; }

    [Parameter]
    public string StoresId { get; set; }

    [Parameter]
    public DateTime from { get; set; }

    [Parameter]
    public DateTime to { get; set; }

    private int[] CustomersIdArray { get; set; }

    private int[] ItemsIdArray { get; set; }

    private int[] StoresIdArray { get; set; }

    public bool IsLoading { get; set; } = true;
    DataGridSettings dataGridSettings;
    public IList<InvoiceForReport> selecteditem { get; set; }
    public IEnumerable<InvoiceForReport> Invoices { get; set; }
    public bool IsExpand { get; set; } = true;
    RadzenDataGrid<InvoiceForReport> invoicegrid;
    public string UserId { get; set; }

    public DataGridSetting LayoutDefault { get; set; }
    public int LayoutIdSelection { get; set; }
    [Inject]
    public LayoutState layoutState { get; set; }
    public async void OpenLayouts()
    {
        var setting = JsonSerializer.Serialize<DataGridSettings>(_settings);
        var columnsfrozensetting = JsonSerializer.Serialize<IEnumerable<string>>(ColumnsFrozen);
        var result = await DialogService.OpenAsync<DataGridLayouts>("",
                new Dictionary<string, object>() { { "UserId", UserId }, { "GridId", GridId }, { "Setting", setting }, { "Id", LayoutIdSelection }, { "IsExpand", IsExpand }, { "ColumnFrozenSetting", columnsfrozensetting } },
               new DialogOptions()
                   {
                       Resizable = false,
                       Draggable = true,

                       Width = "900px",
                       Height = "600px"
                   });

        if (result != null)
        {
            ColumnsFrozen = Enumerable.Empty<string>();
            _settings = JsonSerializer.Deserialize<DataGridSettings>(result.Setting);
            LayoutIdSelection = result.Id;
            IsExpand = result.IsExpand;
            if (result.ColumnsFrozen != null)
            {
                ColumnsFrozen = JsonSerializer.Deserialize<IEnumerable<string>>(result.ColumnsFrozen);


            }
            FrozenColumn();
            StateHasChanged();


        }

    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {


        if (firstRender)
        {
            await runtaskfillcolumnfrozen();

            await gridColumns.Reload();
            if (LayoutDefault is not null)
            {
                _settings = JsonSerializer.Deserialize<DataGridSettings>(LayoutDefault.Setting);
                ColumnsFrozen = JsonSerializer.Deserialize<IEnumerable<string>>(LayoutDefault.ColumnsFrozen);
                FrozenColumn();
                LayoutIdSelection = LayoutDefault.Id;
                IsExpand = LayoutDefault.IsExpand;

            }
            IsLoading = false;
            await InvokeAsync(StateHasChanged);
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    protected override async Task OnInitializedAsync()
    {

        if (!await service.IsAuth())
        {
            nav.NavigateTo("/Account/Login");
            return;
        }

        // await  base.OnInitializedAsync();
        //Invoices = unitofwork.SalesInvoiceDetails.GetDocumentDataForReport(UserId);
        if (CustomersId != null && CustomersId != "null")
        {
            CustomersIdArray = CustomersId?.Split(',').Select(int.Parse).ToArray();
        }
        if (ItemsId != null && ItemsId != "null")
        {
            ItemsIdArray = ItemsId?.Split(',').Select(int.Parse).ToArray();
        }
        if (StoresId != null && StoresId != "null")
        {
            StoresIdArray = StoresId?.Split(',').Select(int.Parse).ToArray();
        }
        UserId = await service.GetUserId();

        Invoices = unitofwork.SalesInvoiceDetails.FilterDocumentDataForReport(CustomersIdArray, ItemsIdArray, StoresIdArray, from, to, InvoiceId,UserId).ToList();
       
        LayoutDefault = dgsetting.GetLayoutDefault(UserId, GridId);

        var menu = await unitofwork.MenuItems.GetAllAsync(m => m.ParentId == "1");
        if (menu != null)
        {
            layoutState.SetMenuItems(menu.ToList());
        }
    }

    Task<int> runtaskfillcolumnfrozen()
    {
        var i = Task.Run(FillColumnsToFrozen);

        return i;
    }

    int FillColumnsToFrozen()
    {
        dataGridColumnsFrozens.Clear();
        for (int i = 0; i < invoicegrid.ColumnsCollection.Count - 1; i++)
        {
            dataGridColumnsFrozens.Add(new()
                {

                    ColumnKey = invoicegrid.ColumnsCollection[i].Property,
                    ColumnTitle = invoicegrid.ColumnsCollection[i].Title,


                });
        }

        return 0;

    }
    void add()
    {
        nav.NavigateTo("/sales-invoice");


    }

    void FrozenColumn()
    {


        foreach (var item in invoicegrid.ColumnsCollection)
        {
            item.Frozen = false;
        }

        if (ColumnsFrozen != null)
        {

            for (int i = 0; i < ColumnsFrozen.Count(); i++)
            {
                invoicegrid.ColumnsCollection.FirstOrDefault(s => s.Property == ColumnsFrozen.ToArray()[i].ToString()).Frozen = true;


            }
        }



    }
    void Edit(InvoiceForReport invoice)
    {
        if (invoice.DocumentTypeID == 2)
        {
            nav.NavigateTo($"sales-invoice/{invoice.InvoiceId}");
        }
        if (invoice.DocumentTypeID == 10)
        {
            nav.NavigateTo($"sales-reverse/{invoice.InvoiceId}");
        }

    }
    void expand()
    {
        IsExpand = true;
    }
    void collapse()
    {
        IsExpand = false;
    }


}
