@page "/add-item-opening-balance"
@page "/add-item-opening-balance/{Id:int}"
@layout Layout.EmptyLayout
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject IUnitOfWork unitofwork
@inject Service service
@inject ItemOpeningBalanceHeader newitemopeningheader
@inject VendorTransaction vendortransaction
@inject MyFarmWeb.Data.MyFarmContext ContextDb
@inject IService jsservice
@inject IJSRuntime jsrun
@inject NavigationManager nv
@using MyFarmWeb.Repository.Enums
@using MyFarmWeb.Components.Pages.MyComponents
@inject DialogService dialogservice
<title>رصيد افتتاحي للاصناف</title>


<RadzenAlert @ref="SaveAlert" Visible=@SaveSucces AllowClose="true" AlertStyle="@Alertstyle" Size="AlertSize.Small" Text=@SaveMessage />
<RadzenFieldset Text="عمليات" Style="color:crimson" >
        <RadzenCard class="rz-my-0">
   
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Wrap="FlexWrap.Wrap">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="20" JustifyContent="JustifyContent.Center">
                    <RadzenButton @ref="NewBtn" Text="جديد" Icon="add" Click="NewInvoice"></RadzenButton>
                    <RadzenButton @ref="SaveBtn" Text="حفظ" Disabled=IsSaveBtnDisabled Icon="save" Click="SaveInvoice"></RadzenButton>
                </RadzenStack>

            </RadzenStack>
   
        </RadzenCard>
</RadzenFieldset>
<RadzenFieldset Text="راس المستند"> 


<RadzenCard class="rz-my-1">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Wrap="FlexWrap.Wrap">
        <RadzenStack Orientation="Orientation.Horizontal">
            <RadzenLabel>رقم المستند</RadzenLabel>
            <RadzenNumeric TValue="int" ReadOnly="true" @bind-Value="newitemopeningheader.ItemBalanceId" Style="margin-right:20px;" TextAlign="Radzen.TextAlign.Center"></RadzenNumeric>
 
            <RadzenLabel>التاريخ</RadzenLabel>
            <RadzenStack Orientation="Orientation.Vertical">
                <RadzenDatePicker @ref="Datecontrol" TValue="DateTime" @onkeydown="Datekeydown" Change="DateChange" @bind-Value="newitemopeningheader.Date" DateFormat="yyyy-MM-dd" style="text-align:center;"></RadzenDatePicker>
                <RadzenAlert Visible=@DateError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text=@DateErrorMessage />
            </RadzenStack>
            <RadzenLabel>ملاحظات</RadzenLabel>
            <RadzenTextBox @bind-Value="newitemopeningheader.Note" Style="display: block;width:50%;margin-right:15px" />

        </RadzenStack>
    </RadzenStack>
  @*   <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" Style="margin-top:15px;">
    </RadzenStack> *@
</RadzenCard>
</RadzenFieldset>

<RadzenAlert Visible=@ItemsCountError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text=@ItemCountErrorMessage />

<RadzenDataGrid @ref="ordersGrid" Style="width:100%;height:400px;" ColumnWidth="200px" AllowAlternatingRows="true" AllowFiltering="false" AllowPaging="false" AllowSorting="false" EditMode="@editMode"
                Data="@purchaseitemToSave" TItem="ItemOpeningBalanceDetails" RowUpdate="@OnUpdateRow" RowCreate="@OnCreateRow" Sort="@Reset" Page="@Reset" Filter="@Reset" EmptyText="لايوجد اي بيانات" AllowColumnPicking="true" ColumnsShowingText="اظهار الاعمدة"
                GridLines="DataGridGridLines.Both">
      <Columns>

        <RadzenDataGridColumn Title="كود الصنف" Property="@nameof(Item.ItemId)" TextAlign="Radzen.TextAlign.Center">
    
            <EditTemplate Context="order">
                <RadzenNumeric TValue="int" @ref="ItemIdControl" Change="() => Getprice(order)" Min="0" Style=@(ItemIdError == true ? "margin-top:40px; display: block;text-align:center;" : "margin-top:0px; display: block;text-align:center;") Name="Item" @bind-Value=order.ItemId TextAlign="Radzen.TextAlign.Center" />
                <RadzenAlert Visible=@ItemIdError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text="كود الصنف غير موجود" />

            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Title="الصنف" Width="300px" Property="@nameof(Item.ItemId)" TextAlign="Radzen.TextAlign.Center">
            <Template Context="order">
                @order.Item?.ItemName
            </Template>
            <EditTemplate Context="order">
                <RadzenDropDown TValue="int" @ref="ItemNameControl" SelectedItemChanged="args => Getprice(args)" Style=@(ItemError == true ? "margin-top:40px; display: block;text-align:center;" : "margin-top:0px; display: block;text-align:center;") Name="Item" Data=@Items @bind-Value=order.ItemId TextProperty="@nameof(Item.ItemName)" ValueProperty="@nameof(Item.ItemId)" AllowFiltering="true" />
                <RadzenAlert Visible=@ItemError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text="يجب ادخال الصنف" />
                <RadzenAlert Visible=@ItemFoundError  AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text="يوجد رصيد افتتاحي للصنف من قبل" />

            </EditTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Title="المخزن" Property="@nameof(ItemOpeningBalanceDetails.StoreId)" TextAlign="Radzen.TextAlign.Center">
            <Template Context="order">
                @order.Store?.StoreName
            </Template>
            <EditTemplate Context="order">
                <RadzenDropDown TValue="int" @ref="ItemStoreControl" Style=@(StoreError == true ? "margin-top:40px; display: block;text-align:center;" : "margin-top:0px; display: block;text-align:center;") Name="Store" Data=@Stores @bind-Value=order.StoreId TextProperty="@nameof(Store.StoreName)" ValueProperty="@nameof(Store.StoreId)" AllowFiltering="true" />
                <RadzenAlert Visible=@StoreError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text="يجب ادخال المخزن" />
            </EditTemplate>

        </RadzenDataGridColumn>




        <RadzenDataGridColumn Property="@nameof(ItemOpeningBalanceDetails.Quantity)" Title="الكمية" TextAlign="Radzen.TextAlign.Center">
            <EditTemplate Context="order">
                <RadzenNumeric TValue="decimal" Min="0" @ref=quantitycontrol Change="SetAmount" Style=@(QuantityError == true ? "margin-top:40px; display: block;" : "margin-top:0px;display: block;") Name="Quantity" @bind-Value=order.Quantity TextAlign="Radzen.TextAlign.Center" />
                <RadzenAlert Visible=@QuantityError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text="يجب ادخال الكمية" />
          </EditTemplate>
            <FooterTemplate>
                @TotalQuantity
            </FooterTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Title="الوحده" Property="@nameof(ItemOpeningBalanceDetails.UnitId)" TextAlign="Radzen.TextAlign.Center">
            <Template Context="order">
                @order.Unit?.UnitName
            </Template>
            <EditTemplate Context="order">
                <RadzenDropDown TValue="int" @ref="ItemUnitControl" Change="() => UnitConvert(order)" Style=@(UnitError == true ? "margin-top:40px; display: block;text-align:center;" : "margin-top:0px; display: block;text-align:center;") Name="Unit" Data=@Units @bind-Value=order.UnitId TextProperty="@nameof(Unit.UnitName)" ValueProperty="@nameof(Unit.UnitId)" AllowFiltering="true" />
                <RadzenAlert Visible=@UnitError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text="يجب ادخال الوحدة" />
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="@nameof(ItemOpeningBalanceDetails.UnitCost)" Title="تكلفة الوحدة" TextAlign="Radzen.TextAlign.Center">
            <EditTemplate Context="order">
                <RadzenNumeric TValue="decimal" Min="0" @ref=pricecontrol Format="N3" Change="SetAmount" Style=@(UnitCostError == true ? "margin-top:40px; display: block;" : "margin-top:0px;display:") Name="UnitCost" @bind-Value=order.UnitCost TextAlign="Radzen.TextAlign.Center" />
                <RadzenAlert Visible=@UnitCostError AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.ExtraSmall" Text="يجب ادخال تكلفة الوحدة" />
            </EditTemplate>
        </RadzenDataGridColumn>


        <RadzenDataGridColumn Property="@nameof(ItemOpeningBalanceDetails.TotalCost)" Title="القيمة" TextAlign="Radzen.TextAlign.Center">
            <EditTemplate Context="order">
                <RadzenNumeric TValue="decimal" Format="N3" ShowUpDown="false" ReadOnly="true" @ref=amountcontrol Style="display: block;width:150px" Name="Amount" @bind-Value=order.TotalCost TextAlign="Radzen.TextAlign.Center" />
            </EditTemplate>
        </RadzenDataGridColumn>

               <RadzenDataGridColumn Property="@nameof(ItemOpeningBalanceDetails.ItemNote)" Width="300px" Title="ملاحظات" TextAlign="Radzen.TextAlign.Center">
            <EditTemplate Context="order">
                <RadzenTextBox Style="display: block;text-align:center;" Name="itemnote" @bind-Value="order.ItemNote" />
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Context="order" Filterable="false" Sortable="false" TextAlign="Radzen.TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
            <Template Context="order">
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => EditRow(order))" @onclick:stopPropagation="true">
                </RadzenButton>
                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(args => DeleteRow(order))" @onclick:stopPropagation="true">
                </RadzenButton>
            </Template>
            <EditTemplate Context="order">
                <RadzenButton Icon="check" @ref=AddControl ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@((args) => SaveRow(order))" aria-label="Save">
                </RadzenButton>
                @if (ordersToInsert.Count > 0)
                {
                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@((args) => CancelEdit(order))" aria-label="Cancel">
                    </RadzenButton>

                }
                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(args => DeleteRow(order))" aria-label="Delete">
                </RadzenButton>
            </EditTemplate>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    public VendorsListComponent vendorsListcontrol { get; set; }
    public bool IsSaveBtnDisabled { get; set; }
    [Parameter]
    public int Id { get; set; }
    DataGridEditMode editMode = DataGridEditMode.Single;
    List<ItemOpeningBalanceDetails> ordersToInsert = new List<ItemOpeningBalanceDetails>();
    List<ItemOpeningBalanceDetails> ordersToUpdate = new List<ItemOpeningBalanceDetails>();
    RadzenDataGrid<ItemOpeningBalanceDetails> ordersGrid;
    IEnumerable<Vendor> Vendors;
    // List<ItemOpeningBalanceDetails> purchaseitem = new List<ItemOpeningBalanceDetails>();
    List<ItemOpeningBalanceDetails> purchaseitemToSave = new List<ItemOpeningBalanceDetails>();
    public StoreMovementHeader StoreMovementHeader { get; set; } = new();
    public List<StoreMovementDetails> StoreMovementDetails { get; set; } = new();
    RadzenNumeric<int> ItemIdControl;
    public decimal TotalQuantity { get; set; }
    IEnumerable<Item> Items;
    IEnumerable<Store> Stores;
    IEnumerable<Unit> Units;
    //---------------------
    RadzenDropDown<int> ItemNameControl;
    RadzenDropDown<int> ItemStoreControl;
    RadzenDropDown<int> ItemUnitControl;
    RadzenDropDownDataGrid<int> vendorcontrol;
    RadzenNumeric<decimal> quantitycontrol;
    RadzenNumeric<decimal> pricecontrol;
    RadzenNumeric<decimal> amountcontrol;
    RadzenNumeric<decimal> Discountcontrol;
    RadzenDatePicker<DateTime> Datecontrol;
    RadzenButton NewBtn;
    RadzenButton SaveBtn;
    RadzenAlert SaveAlert;
    RadzenButton AddControl;
    //-------------------------------
    AlertStyle Alertstyle;
    bool StoreError = false;
    bool ItemError = false;
    bool UnitError = false;
    bool QuantityError = false;
    bool QuantityBalanceError = false;
    bool UnitCostError = false;
    bool VendorError = false;
    bool DateError = false;
    bool ItemsCountError = false;
    bool SaveSucces = false;
    bool DiscountError = false;
    bool TotalDiscountError = false;
    bool ItemIdError = false;
    bool ItemFoundError = false;
    string SaveMessage = "";
    string DateErrorMessage;
    string ItemCountErrorMessage;
    //----------------------------------

    //-----------------
    public decimal TotalDiscount { get; set; }
    decimal ItemBalance = 0;
    public RadzenDataGrid<ItemOpeningBalanceDetails> purchasegrid { get; set; }
    public IEnumerable<ItemOpeningBalanceDetails> PurchaseList { get; set; }
    public Vendor SelectVendor { get; set; }
    List<ItemOpeningBalanceDetails> itemOpeningBalance = new();
    public Item SelectItem { get; set; }
    public Unit SelectUnit { get; set; }
    public Store SelectStore { get; set; }
    public _Year year { get; set; }

    public string UserId { get; set; }
    public ItemOpeningBalanceDetails ThisInvoice { get; set; }
    int FromUnit;
    int ToUnit;
    public Item item { get; set; }
    public float Factory { get; set; }

    [Inject]
    public LayoutState layoutState { get; set; }

    void UnitConvert(ItemOpeningBalanceDetails order)
    {
        if (item == null)
        {
            return;
        }
        FromUnit = item.UnitId;
        if (ordersToInsert.Count > 0)
        {
            Factory = unitofwork.UnitsConverter.CreateFactory(FromUnit, ordersToInsert[0].UnitId);
            if (Factory == 0)
            {
                ordersToInsert[0].UnitId = item.UnitId;
                ordersToInsert[0].UnitCost = item.PurchasePrice;
                dialogservice.Alert("لايوجد ربط بين هذه الوحده والوحده الرئيسية تم الغاء الاختيار", "خطأ");
                SetAmount();

                return;
            }
            if (item is not null)
            {
                if (Factory != 0)
                {
                    ordersToInsert[0].UnitCost = item.PurchasePrice / ((decimal)Factory);

                    ordersToInsert[0].ConvertedQuantity = order.Quantity / ((decimal)Factory);
                    ordersToInsert[0].ConvertedUnitCost = order.UnitCost * ((decimal)Factory);
                    ordersToInsert[0].ConvertedUnitCost = order.UnitCost * ((decimal)Factory);

                }
                else
                {
                    ordersToInsert[0].UnitCost = item.PurchasePrice;
                }
                SetAmount();
                return;
            }
        }
        if (ordersToUpdate.Count > 0)
        {
            Factory = unitofwork.UnitsConverter.CreateFactory(FromUnit, ordersToUpdate[0].UnitId);
            if (Factory == 0)
            {
                ordersToUpdate[0].UnitId = item.UnitId;
                ordersToUpdate[0].UnitCost = item.PurchasePrice;
                dialogservice.Alert("لايوجد ربط بين هذه الوحده والوحده الرئيسية تم الغاء الاختيار", "خطأ");

                SetAmount();
                return;
            }
            if (item is not null)
            {
                if (Factory != 0)
                {
                    ordersToUpdate[0].UnitCost = item.PurchasePrice / ((decimal)Factory);

                    ordersToUpdate[0].ConvertedQuantity = order.Quantity / ((decimal)Factory);
                    ordersToUpdate[0].ConvertedUnitCost = order.UnitCost * ((decimal)Factory);
                    ordersToUpdate[0].ConvertedUnitCost = order.UnitCost * ((decimal)Factory);
                }
                else
                {
                    ordersToUpdate[0].UnitCost = item.PurchasePrice;
                }

                SetAmount();
            }
        }


    }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InsertRow();

            // await jsservice.setfocusbyid(() => vendorsListcontrol.vendorcontrol.UniqueID);

        }

        if (ordersToUpdate != null && ordersToUpdate.Count > 0)
        {
            await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
            await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
            await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
            await jsrun.InvokeVoidAsync("addKeydownListenerItemUnit", ItemUnitControl.UniqueID, DotNetObjectReference.Create(this));
            await jsrun.InvokeVoidAsync("addKeydownListenerItemStore", ItemStoreControl.UniqueID, DotNetObjectReference.Create(this));
            await jsrun.InvokeVoidAsync("addKeydownListenerItemName", ItemNameControl.UniqueID, DotNetObjectReference.Create(this));

        }

    }
    protected override async Task OnInitializedAsync()
    {

        await base.OnInitializedAsync();
        if (!await service.IsAuth())
        {
            nv.NavigateTo("/Account/Login");
            return;
        }
        UserId = await service.GetUserId();
        if (Id > 0)
        {
            // purchaseitemToSave = unitofwork.ItemOpeningBalanceDetails.GetDataWithMultiIncludeById(Id, UserId).ToList();
            //  newitemopeningheader = purchaseitemToSave[0].purchaseInvoiceHeader;
            IsSaveBtnDisabled = true;
            SetTotalQuantity();
        }
        else
        {
            newitemopeningheader.Date = DateTime.Now;
            IsSaveBtnDisabled = false;
        }
        jsservice.JSRuntime = jsrun;

        Vendors = await unitofwork.Vendors.GetAllAsync(v => v.UserId == UserId);
        Items = await unitofwork.Items.GetAllAsync(v => v.UserId == UserId);
        Units = await unitofwork.Units.GetAllAsync(v => v.UserId == UserId);
        Stores = await unitofwork.Stores.GetAllAsync(v => v.UserId == UserId);


        year = unitofwork.Years.SelectOne(u => u.UserId == UserId && u.Status == false);

        var menu = await unitofwork.MenuItems.GetAllAsync(m => m.ParentId == "5");
        if (menu != null)
        {
            layoutState.SetMenuItems(menu.ToList());
        }
    }


    async Task InsertRow()
    {
        if (editMode == DataGridEditMode.Single)
        {
            Reset();
        }

        var order = new ItemOpeningBalanceDetails();
        ordersToInsert.Add(order);

        await ordersGrid.InsertRow(order);
        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);

    }
    async void OnUpdateRow(ItemOpeningBalanceDetails order)
    {
        Reset(order);

        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);


    }
    async void OnCreateRow(ItemOpeningBalanceDetails order)
    {

        var item = unitofwork.Items.GetById(order.ItemId);
        var store = unitofwork.Stores.GetById(order.StoreId);
        var unit = unitofwork.Units.GetById(order.UnitId);
        if (purchaseitemToSave.Count > 0)
        {
            order.Moslsel = purchaseitemToSave.Max(p => p.Moslsel) + 1;
        }
        else
        {
            order.Moslsel = 1;
        }

        order.Item = item;
        order.Store = store;
        order.Unit = unit;
        UnitConvert(order);
        purchaseitemToSave.Add(order);
        ordersToInsert.Remove(order);

        ItemsCountError = false;
        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);

    }
    void Reset()
    {
        ordersToInsert.Clear();
        ordersToUpdate.Clear();
    }

    void Reset(ItemOpeningBalanceDetails order)
    {
        ordersToInsert.Remove(order);
        ordersToUpdate.Remove(order);
    }
    async Task DeleteRow(ItemOpeningBalanceDetails order)
    {
        Reset(order);
        var item = purchaseitemToSave.FirstOrDefault(p => p.Moslsel == order.Moslsel);
        if (item != null)
        {
            purchaseitemToSave.Remove(order);
            await ordersGrid.Reload();
        }
        else
        {
            ordersGrid.CancelEditRow(order);
            await ordersGrid.Reload();
        }
        int c = 1;
        foreach (var i in purchaseitemToSave)
        {

            i.Moslsel = c;
            c++;
        }
        // newitemopeningheader.Total = purchaseitemToSave.Sum(p => p.Amount);
        // newitemopeningheader.NetTotal = purchaseitemToSave.Sum(p => p.NetAmount);
        SetTotalQuantity();
        await InsertRow();
        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);

    }
    async void CancelEdit(ItemOpeningBalanceDetails order)
    {

        if (ordersToInsert.Count > 0)
        {

            purchaseitemToSave.Remove(order);
            ordersGrid.CancelEditRow(order);
            await InsertRow();
            Reset(order);
            SetAmount();

        }

        SetTotalQuantity();
        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);
        ResetErrors();
    }
    async Task SaveRow(ItemOpeningBalanceDetails order)
    {
        if (Items != null)
        {
            var itemIsfound = Items.FirstOrDefault(o => o.ItemId == order.ItemId);
            if (itemIsfound is null ||  order.ItemId <= 0)
            {
                ItemError = true;
                await jsservice.setfocusbyid(() => ItemNameControl.UniqueID);

                return;
            }
            else
            {
                ItemError = false;
            }

        }
        // if (order.ItemId <= 0)
        // {
        //     ItemError = true;
        //     await jsservice.setfocusbyid(() => ItemNameControl.UniqueID);

        //     return;
        // }
        // else
        // {
        //     ItemError = false;
        // }
        // if (Items != null)
        // {
        //     var itemIsfound = Items.FirstOrDefault(o => o.ItemId == order.ItemId);
        //     if (itemIsfound is null)
        //     {
        //         ItemError = true;
        //         await jsservice.setfocusbyid(() => ItemNameControl.UniqueID);

        //         return;
        //     }
        //     else
        //     {
        //         ItemError = false;
        //     }

        // }
        if (order.StoreId <= 0)
        {
            StoreError = true;
            await jsservice.setfocusbyid(() => ItemStoreControl.UniqueID);

            return;
        }
        else
        {
            StoreError = false;
        }

        var itemisfoundinstore = GetItemOpeningBalanceDetails(order.ItemId, order.StoreId);
        var itemisfoundingrid = purchaseitemToSave.FirstOrDefault(p => p.ItemId == order.ItemId && p.StoreId == order.StoreId);

        if ((itemisfoundinstore != null && itemisfoundinstore.ItemId > 0) || (itemisfoundingrid != null && itemisfoundingrid.ItemId > 0))
        {
            ItemFoundError = true;
            await jsservice.setfocusbyid(() => ItemNameControl.UniqueID);
            return;
        }
        else
        {
            ItemFoundError = false;
        }
        if (order.Quantity == 0)
        {
            QuantityError = true;
            await jsservice.SelectAllTextToFisrtChild(() => quantitycontrol.UniqueID);

            return;
        }
        else
        {
            QuantityError = false;

        }
        if (order.UnitId <= 0)
        {
            UnitError = true;
            await jsservice.setfocusbyid(() => ItemUnitControl.UniqueID);

            return;
        }
        else
        {
            UnitError = false;

        }
        if (order.UnitCost == 0)
        {
            UnitCostError = true;
            await jsservice.SelectAllTextToFisrtChild(() => pricecontrol.UniqueID);

            return;
        }
        else
        {
            UnitCostError = false;
        }


        var item = unitofwork.Items.GetById(order.ItemId);
        var store = unitofwork.Stores.GetById(order.StoreId);
        var unit = unitofwork.Units.GetById(order.UnitId);
        order.Item = item;
        order.Store = store;
        order.Unit = unit;
        UnitConvert(order);
        await ordersGrid.UpdateRow(order);
        await InsertRow();

        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);

    }
    async Task EditRow(ItemOpeningBalanceDetails order)
    {
        if (editMode == DataGridEditMode.Single && ordersToInsert.Count() > 0)
        {
            Reset();
        }

        ordersToUpdate.Add(order);

        await ordersGrid.EditRow(order);
        await ordersGrid.Reload();

        StoreError = false;
        ItemError = false;
        UnitError = false;
        QuantityError = false;
        UnitCostError = false;
        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);

    }
    void SetAmount()
    {

        if (ordersToInsert.Count > 0)
        {
            ordersToInsert[0].TotalCost = (ordersToInsert[0].Quantity * ordersToInsert[0].UnitCost);
        }
        if (ordersToUpdate.Count > 0)
        {
            ordersToUpdate[0].TotalCost = (ordersToUpdate[0].Quantity * ordersToUpdate[0].UnitCost);

        }
        SetTotalQuantity();

    }
    async void NewInvoice()
    {
        IsSaveBtnDisabled = false;
        // SaveBtn.Disabled = false;
        newitemopeningheader = new();
        itemOpeningBalance = new();
        purchaseitemToSave.Clear();
        vendortransaction = new();
        StoreMovementHeader = new();
        StoreMovementDetails = new();
        TotalQuantity = 0;
        newitemopeningheader.Date = DateTime.Now;

        await ordersGrid.Reload();
        await InsertRow();


        ResetErrors();
        await jsrun.InvokeVoidAsync("addKeydownListenerItemId", ItemIdControl.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerQuantity", quantitycontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsrun.InvokeVoidAsync("addKeydownListenerprice", pricecontrol.UniqueID, DotNetObjectReference.Create(this));
        await jsservice.setfocusbyidtofirstchild(() => ItemIdControl.UniqueID);
        await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);

    }
    void SaveInvoice()
    {


        // if (newitemopeningheader.PurchaseInvoiceDate.Year != year.YearName)
        // {
        //     DateError = true;
        //     DateErrorMessage = "يجب ان يكون تاريخ الفاتورة فى نفس العام المالى";
        //     return;
        // }else
        // {
        //     DateError = false;
        // }
        if (purchaseitemToSave.Count == 0)
        {
            ItemsCountError = true;
            ItemCountErrorMessage = "يجب ادخال صنف الاقل ";
            return;

        }
        else
        {
            ItemsCountError = false;
        }
        if (ordersToInsert.Count != 0)
        {
            if (ordersToInsert.Count > 0 && ordersToInsert[0].ItemId > 0 || ordersToInsert[0].UnitCost > 0 || ordersToInsert[0].Quantity > 0)
            {
                ItemsCountError = true;
                ItemCountErrorMessage = "هناك صنف فى وضع التحرير يجب الغاءه او اضافته";
                return;

            }
            else
            {
                ItemsCountError = false;
            }
        }

        if (ordersToUpdate.Count != 0)
        {
            if (ordersToUpdate.Count > 0 && ordersToUpdate[0].ItemId > 0 || ordersToUpdate[0].UnitCost > 0 || ordersToUpdate[0].Quantity > 0)
            {
                ItemsCountError = true;
                ItemCountErrorMessage = "هناك صنف فى وضع التحرير يجب الغاءه او اضافته";
                return;

            }
            else
            {
                ItemsCountError = false;
            }
        }



        using (ContextDb.Database.BeginTransaction())
        {
            try
            {
                DateTime CreateDate = DateTime.Now;
                int movementdocumentid = unitofwork.StoreMovementHeader.GetMaxId(s => s.MovementDocumentId, h => h.TypeId == 1) + 1;
                int movementid = unitofwork.StoreMovementHeader.GetMaxId(s => s.MovementId) + 1;
                //insert to purchase header
                int invoiceid = unitofwork.ItemOpeningBalanceHeader.GetMaxId(s => s.ItemBalanceId) + 1;
                newitemopeningheader.ItemBalanceId = invoiceid;
                newitemopeningheader.UserId = UserId;
                newitemopeningheader.Year = year.Year;
                newitemopeningheader.CreateDate = CreateDate;
                ContextDb.ItemOpeningBalanceHeader.Add(newitemopeningheader);

                //insert to purchase details


                foreach (var item in purchaseitemToSave)
                {
                    item.ItemBalanceId = invoiceid;

                    itemOpeningBalance.Add(item.Clone());
                    StoreMovementDetails.Add(new Models.Models.StoreMovementDetails()
                    {
                        // Id = unitofwork.StoreMovementDetails.GetMaxId(s => s.Id) + 1,

                        MovementId = movementid,
                        ItemId = item.ItemId,
                        StoreId = item.StoreId,
                        UnitId = item.UnitId,
                        Quantity = item.Quantity,
                        Cost = item.UnitCost,
                        ConvertedCost = item.ConvertedUnitCost,
                        ConvertedQuantity = item.ConvertedQuantity,
                        UnitIdMain = item.UnitIdMain,
                        TotalCost = item.TotalCost,
                        Note = item.ItemNote,
                    });

                }

                ContextDb.ItemOpeningBalanceDetails.AddRange(itemOpeningBalance);

                // insert to store movement header
                StoreMovementHeader.MovementDocumentId = movementdocumentid;
                StoreMovementHeader.MovementId = movementid;
                StoreMovementHeader.Date = newitemopeningheader.Date;
                StoreMovementHeader.TypeId = 1; // وارد
                StoreMovementHeader.DocumentTypeId = (int)DocumentTypesEnum.OpeningBalance; 
                StoreMovementHeader.DocumentId = invoiceid;
                StoreMovementHeader.UserId = UserId;
                StoreMovementHeader.Year = year.Year;
                StoreMovementHeader.CreateDate = CreateDate;
                StoreMovementHeader.Note = newitemopeningheader.Note;
                ContextDb.StoreMovementHeader.Add(StoreMovementHeader);

                //insert to store movement details

                ContextDb.StoreMovementDetails.AddRange(StoreMovementDetails);


                ContextDb.SaveChanges();
                ContextDb.Database.CommitTransaction();
                // SaveBtn.Disabled = true;
                IsSaveBtnDisabled = true;
                SaveSucces = true;
                SaveMessage = $"تم الحفظ بنجاح رقم الفاتورة {newitemopeningheader.ItemBalanceId} ";

                Alertstyle = AlertStyle.Success;
                Thread t1 = new Thread(new ThreadStart(Closemessage));
                t1.Start();

            }
            catch (Exception ex)
            {

                ContextDb.Database.RollbackTransaction();
                SaveSucces = true;
                SaveMessage = $"حدث خطأ  {ex.Message} ";
                newitemopeningheader.ItemBalanceId = 0;
                Alertstyle = AlertStyle.Danger;

            }

        }




    }

    void DateChange()
    {
        if (newitemopeningheader.Date.Year == year.YearName)
        {
            DateError = false;
        }
    }

    ItemOpeningBalanceDetails GetItemOpeningBalanceDetails(int itemId, int storeId)
    {
        return unitofwork.ItemOpeningBalanceDetails.SelectOne(s => s.ItemId == itemId && s.StoreId == storeId);

    }
    decimal GetItemBalance(int ItemId, int StoreId)
    {
        var q = unitofwork.StoreMovementDetails.GetItemBalance(s => s.ItemId == ItemId && s.StoreId == StoreId, s => s.Quantity);
        return q;
    }
    void ResetErrors()
    {
        try
        {
            StoreError = false;
            ItemError = false;
            UnitError = false;
            QuantityError = false;
            QuantityBalanceError = false;
            UnitCostError = false;
            VendorError = false;
            DateError = false;
            ItemsCountError = false;
            DiscountError = false;
            TotalDiscountError = false;
            SaveSucces = false;
            ItemIdError = false;
            ItemFoundError = false;
            StateHasChanged();
        }
        catch (Exception)
        {
            
            throw;
        }
    
      
    }
    void Closemessage()
    {

        Thread.Sleep(5000);
        SaveSucces = false;
        ResetErrors();
        InvokeAsync(() => this.StateHasChanged());

    }
    void vendorkeydown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            jsservice.setfocusbyid(() => Datecontrol.UniqueID);
        }
    }
    void Datekeydown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            jsservice.setfocusbyid(() => ordersGrid.UniqueID);
        }
    }
    void Getprice(object args)
    {
        Item item = ((Item)args);

        if (ordersToInsert.Count > 0)
        {
            ordersToInsert[0].UnitCost = item.PurchasePrice;
            ordersToInsert[0].StoreId = item.StoreId;
            ordersToInsert[0].UnitId = item.UnitId;

        }
        if (ordersToUpdate.Count > 0)
        {
            ordersToUpdate[0].UnitCost = item.PurchasePrice;
            ordersToUpdate[0].StoreId = item.StoreId;
            ordersToUpdate[0].UnitId = item.UnitId;
        }
        SetAmount();
    }
    async void Getprice(ItemOpeningBalanceDetails order)
    {
        // item = await unitofwork.Items.GetByIdAsync(i => i.ItemId == itemid,i => i.UserId == UserId);
        if (Items != null)
        {
            item = Items.FirstOrDefault(o => o.ItemId == order.ItemId);

        }
        if (item is null)
        {
            ItemIdError = true;
            return;
        }
        else
        {
            ItemIdError = false;
        }
        
        
        if (ordersToInsert.Count > 0)
        {
            ordersToInsert[0].UnitCost = item.PurchasePrice;
            ordersToInsert[0].StoreId = item.StoreId;
            ordersToInsert[0].UnitId = item.UnitId;

        }
        if (ordersToUpdate.Count > 0)
        {
            ordersToUpdate[0].UnitCost = item.PurchasePrice;
            ordersToUpdate[0].StoreId = item.StoreId;
            ordersToUpdate[0].UnitId = item.UnitId;
        }
        if (item.Unit?.UnitTypeId == 2)
        {
            order.UnitIdMain = unitofwork.UnitsConverter.GetById(item.UnitId).UnitMainId;
        }
        else
        {
            order.UnitIdMain = item.UnitId;
        }
        SetAmount();
        ResetErrors();
    }
    void Invoices()
    {
        nv.NavigateTo("item_purchase_report_selector");
    }
    void SetTotalQuantity()
    {
        TotalQuantity = ordersToInsert.Count > 0 ? purchaseitemToSave.Sum(i => i.Quantity) + ordersToInsert[0].Quantity : purchaseitemToSave.Sum(i => i.Quantity);
    }

    public async void HandleKeydownCustomer(KeyboardEventArgs e)

    {
        if (e.Key == "Enter")
        {

            await jsservice.SelectAllTextToFisrtChild(() => ItemIdControl.UniqueID);
        }

    }



    [JSInvokable]
    public async void HandleKeydownItemID(string key)

    {
        if (key == "Enter")
        {

            await jsservice.SelectAllTextToFisrtChild(() => quantitycontrol.UniqueID);
        }

    }
    [JSInvokable]
    public async void HandleKeydownItemName(string key)

    {
        if (key == "Enter")
        {

            await jsservice.SelectAllTextToFisrtChild(() => quantitycontrol.UniqueID);
        }

    }

    [JSInvokable]
    public async void HandleKeydownItemStore(string key)

    {
        if (key == "Enter")
        {

            await jsservice.SelectAllTextToFisrtChild(() => quantitycontrol.UniqueID);
        }

    }
    [JSInvokable]
    public async void HandleKeydownItemUnit(string key)

    {
        if (key == "Enter")
        {

            await jsservice.SelectAllTextToFisrtChild(() => quantitycontrol.UniqueID);
        }

    }
    [JSInvokable]
    public async void HandleKeydownQuantity(string key)
    {
        if (key == "Enter")
        {

            await jsservice.SelectAllTextToFisrtChild(() => pricecontrol.UniqueID);

        }

    }
    [JSInvokable]
    public async void HandleKeydownDiscount(string key)
    {
        if (key == "Enter")
        {


            await jsservice.setfocusbyid(() => AddControl.UniqueID);

        }

    }
    [JSInvokable]
    public async void HandleKeydownPrice(string key)
    {
        if (key == "Enter")
        {

            await jsservice.setfocusbyid(() => AddControl.UniqueID);

        }

    }
}
