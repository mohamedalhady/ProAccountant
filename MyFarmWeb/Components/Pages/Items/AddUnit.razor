@page "/add-unit"
@page "/add-unit/{Id:int}"
@using Radzen.Blazor.Rendering
@inject IUnitOfWork unitofwork
@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject Service service
@inject NavigationManager nav
@inject NotificationService NotificationService
@rendermode InteractiveServer
@inject Unit unit
@inject DialogService dialogService
<PageTitle>اضافة وحدة صنف </PageTitle>
<EditForm Model="unit" FormName="add-unit" class="form-control p-5 m-2 ">


    @if (Errors.Count > 0)
    {
        <RadzenAlert @ref=erroralert AllowClose="false" AlertStyle="AlertStyle.Danger" Size="AlertSize.Small" class="mb-5">
            <ul>
                @foreach (var item in Errors)
                {
                    <li>@item.Value</li>
                }
            </ul>
        </RadzenAlert>
    }


    <RadzenRow class="mb-4">
        <RadzenLabel Text="اسم الوحدة" Component="unitname" Style=" max-width: 200px;" />
        <RadzenTextBox @bind-Value=unit.UnitName Style="max-width:400px;width:100%" Name="unitname" />


    </RadzenRow>
    <RadzenRow class="mb-4">
        <RadzenLabel Text="نوع الوحدة" Component="unitname" Style=" max-width: 200px;" />
        <RadzenDropDown TValue="int" Data="UnitType" ValueProperty="TypeId" TextProperty="TypeName" @bind-Value="unit.UnitTypeId" />

    
    </RadzenRow>

    <RadzenRow>
      <RadzenButton @ref="newbtn" ButtonType="ButtonType.Button" Shade="Shade.Darker" Text="جديد" Icon="add" ButtonStyle="ButtonStyle.Info" Click="newunit" />
      <RadzenButton @ref="addbtn" ButtonType="ButtonType.Submit" Shade="Shade.Darker" Text="@(Id > 0 ? "تعديل" : "حفظ")" Icon="save" ButtonStyle="ButtonStyle.Info" Click="addunit" />

    </RadzenRow>

</EditForm>
@code {
    [Parameter]
    public int Id { get; set; }
    RadzenButton newbtn;
    RadzenButton Cancelbtn;

    public RadzenButton addbtn { get; set; }
    Dictionary<string, string> Errors = new();
    RadzenAlert erroralert;
    public string UserId { get; set; }
    public bool IsValid { get; set; }
    List<UnitType> UnitType = new(); 

    [Inject]
    public LayoutState layoutState { get; set; }

    protected override async Task OnInitializedAsync()
    {

        if (!await service.IsAuth())
        {
            nav.NavigateTo("/Account/Login");
            return;
        }
        UserId = await service.GetUserId();
        if (Id > 0)
        {
            unit = unitofwork.Units.SelectOne(i => i.UnitId == Id && i.UserId == UserId);
        }
        UnitType.Add(new Models.Models.UnitType()
            {
                TypeId = 1,
                TypeName = "رئيسي"
            });
        UnitType.Add(new Models.Models.UnitType()
            {
                TypeId = 2,
                TypeName = "فرعي"
            });

        var menu = await unitofwork.MenuItems.GetAllAsync(m => m.ParentId == "5");
        if (menu != null)
        {
            layoutState.SetMenuItems(menu.ToList());
        }
    }

    void newunit()
    {
        unit = new();
        Errors.Clear();
        Id = 0;
        addbtn.Text = "حفظ";
    }
    async void addunit()
    {
        try
        {
            if (!validation())
            {
                return;
            }
            if (Id > 0)
            {
                unitofwork.Units.UpdateOne(unit);
            }
            else
            {
                unit.UserId = UserId;
                unitofwork.Units.AddOne(unit);
                Id = unit.UnitId;
                addbtn.Text = "تعديل";
                dialogService.Close(true);
            }
         

            NotificationService.Notify(NotificationSeverity.Success, "تم الحفظ بنجاح", "", 3000);
        }
        catch (Exception ex)
        {

            NotificationService.Notify(NotificationSeverity.Error, "خطأ", ex.Message, 3000);
        }

    }
   
    bool validation()
    {
        Errors.Clear();
        if (string.IsNullOrEmpty(unit.UnitName))
        {
            Errors.Add("unitname", "يجب ادخال اسم الوحدة");

        }
        if (Errors.Count > 0)
        {
            IsValid = false;
        }
        else
        {
            IsValid = true;
        }
        return IsValid;
    }
}
